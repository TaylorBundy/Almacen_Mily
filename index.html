<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Articulos - Almac√©n Mily</title>
<link rel="shortcut icon" href="favicon.ico">
<link rel="stylesheet" href="style.css">
</head>
<body>
  <!-- <div class="cabecera">
    <div class="LogoContainer">
      <img id="logo" src="images/Logo.avif" alt="Logo Almac√©n Mily">
      <h1>Almac√©n Mily - Gesti√≥n de Art√≠culos</h1>
    </div>
  </div> -->

<div class="panel">
  <div class="LogoContainer">
    <div class="ImgContainer">
      <img class="logo" id="logo1" src="images/Logo.avif" alt="Logo Almac√©n Mily">
      <img class="logo" id="logo2" src="images/Logo.avif" alt="Logo Almac√©n Mily">
    </div>
    <h1>Almac√©n Mily - Gesti√≥n de Art√≠culos</h1>
  </div>
  <h2>üì¶ B√∫squeda de Art√≠culos</h2>
  <div class="FileContainer">
    <img id="btnImage" src="icons/add-document.avif">
    <label>Cargar base de datos (.CSV): </label>
    <button id="btnCargar"
          onmouseover="mostrarTooltip(event, TitulosList.btnCargar); event.stopPropagation();"
          onmouseout="ocultarTooltip(2000)">
      <img id="btnImage" src="icons/add-document.avif">
      Seleccionar archivo
      <!-- <p id="buscarAnterior">Anterior</p> -->
    </button>
    <span id="fileName">Ning√∫n archivo seleccionado</span>
    <input type="file" id="fileInput" accept=".csv"><br>
  </div>
  <div class="porcentajeContainer">
    <img id="btnImage" class="porcentajeImg" src="icons/porcentaje.avif">
    <input type="text" id="porcentajeInput" maxlength="3" placeholder="Aplicar % Deudores" onmouseover="mostrarTooltip(event, TitulosList.porcentajeInput)" onmouseout="ocultarTooltip(2000)">
    <div class="chkContainer" onmouseover="mostrarTooltip(event, TitulosList.chkPorcentaje)" onmouseout="ocultarTooltip(2000)">
      <input type="checkbox" class="radio" id="porcentajeChk" onmouseover="mostrarTooltip(event, TitulosList.chkPorcentaje)" onmouseout="ocultarTooltip(2000)">Mostrar porcentaje deudores
    </div>
  </div>
  <div class="SearchContainer">
    <img id="btnImage" class="searching" src="icons/search.avif">
    <!-- <input type="text" id="searchInput" placeholder="Buscar por nombre o ID" oninput="buscar()" onmouseover="mostrarTooltip(event, TitulosList.searchInput)" onmouseout="ocultarTooltip(2000)"> -->
    <input type="text" id="searchInput" placeholder="Buscar por nombre o ID" onmouseover="mostrarTooltip(event, TitulosList.searchInput)" onmouseout="ocultarTooltip(2000)">
    <button id="btnAbrirModal" onclick="abrirModal()" onmouseover="mostrarTooltip(event, TitulosList.btnFormularioAgregar)" onmouseout="ocultarTooltip(2000)"><img id="btnImage" src="icons/add-item.avif">Agregar art√≠culo</button>
    <button id="btnAbrirModalEditar" onclick="abrirModalEditar()" onmouseover="mostrarTooltip(event, TitulosList.btnFormularioEditar)" onmouseout="ocultarTooltip(2000)"><img id="btnImage" src="icons/edit.avif">Editar art√≠culo</button>
    <button id="btnAbrirModalEliminar" onclick="abrirModalEliminar()" onmouseover="mostrarTooltip(event, TitulosList.btnFormularioEliminar)" onmouseout="ocultarTooltip(2000)"><img id="btnImage" src="icons/borrar.avif">Eliminar art√≠culo</button>
    <button id="btnGuardar" onclick="guardarCSV()" onmouseover="mostrarTooltip(event, TitulosList.btnGuardar)" onmouseout="ocultarTooltip(2000)"><img id="btnImage" src="icons/save.avif">Guardar cambios</button>
    <!-- <button id="btnGuardar2" onclick="guardarEnGitHub()" onmouseover="mostrarTooltip(event, TitulosList.btnGuardar)" onmouseout="ocultarTooltip(2000)"><img id="btnImage" src="icons/save.avif">Guardar cambios GitHub</button> -->
  </div>
  <div id="contador">Art√≠culos cargados: 0</div>
  <table id="tabla">
    <thead>
      <tr>
        <th class="indice">#</th>
        <th class="codigo">C√≥digo Barra</th>
        <th class="id">ID</th>
        <th class="producto">Nombre</th>
        <th class="precio1">Precio Venta</th>
        <th class="precio2">Precio Deudor</th>
        <th class="fecha">Actualizado</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>
<!-- Modal -->
<div id="modal" aria-label="Modal para agregar art√≠culo">
  <div id="container" onmouseover="mostrarTooltip(event, TitulosList.modales)" onmouseout="ocultarTooltip(2000)">
    <h3>Agregar Art√≠culo</h3>
    <label class="labelModal">C√≥digo Barra:</label>
    <input class="inputNumber" type="number" id="nuevoCodigo" maxlength="13" pattern="\d{0,13}" onkeypress="if(this.value.length==13) return false;" onmouseover="mostrarTooltip(event, TitulosList.codigo); event.stopPropagation();" onmouseout="ocultarTooltip(2000)">
    <label class="labelModal">Nombre Producto:</label>
    <input type="text" id="nuevoNombre" onmouseover="mostrarTooltip(event, TitulosList.nombre); event.stopPropagation();" onmouseout="ocultarTooltip(2000)">
    <label class="labelModal">Precio Venta:</label>
    <input class="inputNumber" type="text" id="nuevoPrecio1" maxlength="6" onfocus="formatearCampo(this)" onkeypress="if(this.value.length==7) return false;" onmouseover="mostrarTooltip(event, TitulosList.precio1); event.stopPropagation();" onmouseout="ocultarTooltip(2000)">
    <label class="labelModal">Precio Deudor:</label>
    <input class="inputNumber" type="text" id="nuevoPrecio2" maxlength="6" onkeypress="if(this.value.length==7) return false;" onmouseover="mostrarTooltip(event, TitulosList.precio2); event.stopPropagation();" onmouseout="ocultarTooltip(2000)"><br>
    <div class="btnContainer">
      <button id="btnAgregarArticulo" onclick="agregarArticulo()" onkeypress="Javascript: if (event.keyCode==13) agregarArticulo();" onmouseover="mostrarTooltip(event, TitulosList.btnAgregar); event.stopPropagation();" onmouseout="ocultarTooltip(2000)"><img id="btnImage" src="icons/ok.avif">Agregar</button>
      <button id="btnLimpiar" onmouseover="mostrarTooltip(event, TitulosList.btnLimpiar); event.stopPropagation();" onmouseout="ocultarTooltip(2000)">
        <img id="btnImage" src="icons/limpiar.avif">Limpiar
      </button>
      <button onclick="cerrarModal()" onmouseover="mostrarTooltip(event, TitulosList.btnCancelar); event.stopPropagation();" onmouseout="ocultarTooltip(2000)"><img id="btnImage" src="icons/cancel.avif">Cancelar</button>
    </div>
  </div>
</div>
<div id="modalEditar" class="modal" style="display:none;">
  <div id="containerEditar" class="modalContainer">
    <h3>Editar Art√≠culo</h3>

    <label class="labelModal">Buscar por ID o NOMBRE:</label>
    <div class="buscarContainer">
      <input type="text" id="buscarEditar" placeholder="Ej: 102 o Pan Lactal" onkeyup="buscarArticuloEditar()">
      <button id="btnAnteriorEditar" title="" onclick="mostrarAnteriorCoincidencia2()" onmouseover="mostrarTooltip(event, TitulosList.btnAnterior); event.stopPropagation();"
      onmouseout="ocultarTooltip(2000)"><img id="btnImageSiguiente" src="icons/atras.avif"></button>
      <button id="btnSiguienteEditar" title="" onclick="mostrarSiguienteCoincidencia2()" onmouseover="mostrarTooltip(event, TitulosList.btnSiguiente); event.stopPropagation();"
      onmouseout="ocultarTooltip(2000)"><img id="btnImageSiguiente" src="icons/adelante.avif"></button>
    </div>
    <div class="contadorContainer">
      <p id="contadorEditar" class="contadorCoincidencias">0 coincidencias</p>
      <p id="contadorEditarTotal" class="contadorCoincidencias">0 de 0</p>
    </div>

    <div class="resultadoEditar">
      <div class="campo">
        <strong>Id:</strong> <span id="codigoEncontrado">-</span>
      </div>
      <div class="campo">
        <strong>Nombre:</strong> <span id="nombreEncontrado">-</span>
      </div>
      <div class="campoPrecio">
        <strong>Precio Venta: <span id="precioEncontrado">-</span> </strong>
        <input type="text" id="nuevoPrecio1Editar" onfocus="formatearCampo(this)" placeholder="Ej: 3500.00">
      </div>
      <div class="campoPrecio">
        <strong>Precio Deudor: <span id="precioEncontrado2">-</span> </strong>
        <input type="text" id="nuevoPrecio2Editar" onfocus="formatearCampo(this)" placeholder="Ej: 3200.00 (opcional)">
      </div>
    </div>

    <div class="btnContainer">
      <button id="btnGuardarEditar" class="btnAceptar" disabled onmouseover="mostrarTooltip(event, TitulosList.btnGuardarEditar); event.stopPropagation();" onmouseout="ocultarTooltip(2000)">
        <img id="btnImage" src="icons/ok.avif" alt=""> Guardar
      </button>
      <button id="btnCancelarEditar" class="btnCancelar" onclick="cerrarModalEditar()" onmouseover="mostrarTooltip(event, TitulosList.btnCancelar); event.stopPropagation();" onmouseout="ocultarTooltip(2000)">
        <img id="btnImage" src="icons/cancel.avif" alt=""> Cancelar
      </button>
    </div>
  </div>
</div>
<!-- üóëÔ∏è Modal Eliminar Art√≠culo -->
<div id="modalEliminar" aria-label="Modal para eliminar art√≠culo" style="display:none;">
  <div id="containerEliminar" onmouseover="mostrarTooltip(event, TitulosList.modales)" onmouseout="ocultarTooltip(2000)">
    <!-- Cuenta regresiva -->
    <div id="contadorCerrar" style="
      position: absolute;
      top: 8px;
      right: 8px;
      background: rgba(0,0,0,0.7);
      color: white;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      display: none;
      width: 150px;
    ">El formulario se cerrar√° en: 5 segundos</div>
    
    <h3>Eliminar Art√≠culo</h3>

    <!-- üîç Campo de b√∫squeda -->
    <label class="labelModal">Buscar por ID o NOMBRE:</label>
    <div class="buscarContainer">
      <input type="text" id="buscarEliminar" onkeyup="buscarArticuloEliminar()" 
            placeholder="Ej: 102 o Pan Lactal"
            onmouseover="mostrarTooltip(event, TitulosList.searchInput); event.stopPropagation();"
            onmouseout="ocultarTooltip(2000)">
      <button id="btnAnterior" onclick="mostrarAnteriorCoincidencia()"
            onmouseover="mostrarTooltip(event, TitulosList.btnAnterior); event.stopPropagation();"
            onmouseout="ocultarTooltip(2000)">
        <img id="btnImageSiguiente" src="icons/atras.avif">
        <!-- <p id="buscarAnterior">Anterior</p> -->
      </button>
      <button id="btnSiguiente" onclick="mostrarSiguienteCoincidencia()"
            onmouseover="mostrarTooltip(event, TitulosList.btnSiguiente); event.stopPropagation();"
            onmouseout="ocultarTooltip(2000)">
        <!-- <p id="buscarSiguiente">Siguiente</p> -->
        <img id="btnImageSiguiente" src="icons/adelante.avif">
      </button>
    </div>
    <!-- üî¢ Contador de coincidencias -->
    <p id="contadorCoincidencias" class="contadorCoincidencias">0 coincidencias</p>
    <p id="contadorTotal" class="contadorCoincidencias">0 de 0</p>

    <!-- üìã Resultado -->
    <div id="resultadoEliminar" class="resultadoEliminar"> <!-- onmouseover="mostrarTooltip(event, TitulosList.resultadoEliminar); event.stopPropagation();" onmouseout="ocultarTooltip()"> -->
      <p id="codigoEncontradoP"><b>Id:</b> <span id="codigoEncontrado">-</span></p>
      <p id="nombreEncontradoP"><b>Nombre:</b> <span id="nombreEncontrado">-</span></p>
      <p id="precioEncontradoP"><b>Precio Venta:</b> <span id="precioEncontrado">-</span></p>
      <p id="precioEncontrado2P"><b>Precio Deudor:</b> <span id="precioEncontrado2">-</span></p>
    </div>

    <!-- üß≠ Botones -->
    <div class="btnContainer">
      <button id="btnEliminar" onclick="eliminarArticuloSeleccionado()" disabled
              onmouseover="mostrarTooltip(event, TitulosList.btnEliminar); event.stopPropagation();"
              onmouseout="ocultarTooltip(2000)">
        <img id="btnImage" src="icons/borrar.avif">Eliminar
      </button>
      <!-- <button id="btnLimpiar" onmouseover="mostrarTooltip(event, TitulosList.btnLimpiar); event.stopPropagation();" onmouseout="ocultarTooltip()">
        <img id="btnImage" src="icons/limpiar.avif">Limpiar
      </button> -->
      <button onclick="cerrarModalEliminar()" 
              onmouseover="mostrarTooltip(event, TitulosList.btnCancelar); event.stopPropagation();"
              onmouseout="ocultarTooltip(2000)">
        <img id="btnImage" src="icons/cancel.avif">Cancelar
      </button>
    </div>
  </div>
</div>
<!-- Modal para cargar archivo -->
<div id="modalCargar">
  <div id="modalContenido">
    <h3>üìÇ Seleccionar archivo</h3>
    <p>Seleccione el archivo CSV que desea cargar.</p>
    <button class="boton" id="btnAceptar">Aceptar</button>
    <button class="boton" id="btnCancelar" style="background-color:#6c757d;">Cancelar</button>
  </div>
</div>
<script src="script.js"></script>
<script src="cargar_json.js"></script>
<script>
  // Ejecutar al cargar la p√°gina
  //document.addEventListener('DOMContentLoaded', cargarJSON);
  const fileInput = document.querySelector('#fileInput');
  const boton = document.querySelector("#btnCargar");
  const btnAceptar = document.getElementById("btnAceptar");
  const btnCancelar = document.getElementById("btnCancelar");
  const csvGuardado = localStorage.getItem("csvData");
  //const csvGuardado = localStorage.getItem("csvData");
  //const datosGuardados = JSON.parse(localStorage.getItem('csvData') || 'null');

  // async function guardarEnGitHub2() {
  //   const repo = "TaylorBundy/Almacen_Mily";
  //   const contenido = localStorage.getItem("jsonData"); // Ejemplo de tu tabla

  //   await fetch(`https://api.github.com/repos/${repo}/dispatches`, {
  //     method: "POST",
  //     headers: {
  //       "Accept": "application/vnd.github.everest-preview+json",
  //       "Authorization": `token ${ secrets.GITHUB_TOKEN }`,
  //     },
  //     body: JSON.stringify({
  //       event_type: "actualizar-json",
  //       client_payload: {
  //         contenido: contenido
  //       }
  //     })
  //   });

  //   alert("‚úÖ Se envi√≥ la actualizaci√≥n a GitHub");
  // }
  // async function guardarEnGitHub() {
  //   const repo = "TaylorBundy/Almacen_Mily"; // tu repo
  //   const workflow = "actualizar-json.yml"; // nombre del workflow
  //   const contenido = localStorage.getItem("jsonData"); // tu JSON

  //   // Llamar al API de GitHub para disparar workflow_dispatch
  //   const response = await fetch(`https://api.github.com/repos/${repo}/actions/workflows/${workflow}`, {
  //     method: "POST",
  //     headers: {
  //       "Accept": "application/vnd.github.v3+json"
  //       // ‚ö†Ô∏è No hay token aqu√≠, seguridad total
  //     },
  //     body: JSON.stringify({
  //       ref: "main", // branch donde est√° el workflow
  //       inputs: {
  //         contenido: contenido
  //       }
  //     })
  //   });

  //   if (response.ok) {
  //     alert("‚úÖ Workflow disparado correctamente. GitHub actualizar√° el JSON.");
  //   } else {
  //     alert("‚ùå Error al disparar workflow. Ver consola.");
  //     console.log(await response.text());
  //   }
  // }


  async function cargarCSV() {
    const OriginalFile = localStorage.getItem(archivoOriginal);
    // Ver si ya hay datos guardados en localStorage
    if (csvGuardado) {
      if (!OriginalFile) {
          //console.log(`no existe: ${archivoOriginal}`);
          localStorage.removeItem(csvDatos);
      } else {
        //console.log(`existe: ${archivoOriginal}`);
      }
      procesarCSV(csvGuardado);
      fileName2.textContent = localStorage.getItem("csvName") || 'Lista_Precios.csv';
      observer.disconnect(); // Detener la observaci√≥n
      return;
    }

    fileInput.addEventListener('change', e => {
      //console.log('estamos aca');
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = ev => {
        const texto = ev.target.result;
        localStorage.setItem("csvData", texto); // Guardar para uso offline futuro
        localStorage.setItem("csvName", 'Lista_Precios.csv'); // Guardar para uso offline futuro
        // si no existen los datos del archivo original en localstorage, los creamos
        if (!OriginalFile) {
          //console.log(`no existe: ${archivoOriginal}`);
          localStorage.setItem(archivoOriginal, texto); // Guardar para uso offline futuro
        }
        fileName2.textContent = fileInput.files[0].name;
        nombre = fileName2.textContent;
        procesarCSV(texto);
        //console.log("üì¶ CSV cargado y guardado localmente");
      };
      reader.readAsText(file, 'UTF-8');
    });
  }

  // Para probar desde cero
  function borrarCSVGuardado() {
    localStorage.removeItem("csvData");
    alert("CSV local borrado. Se pedir√° cargarlo de nuevo al iniciar.");
  }

  // Ejecutar autom√°ticamente al cargar la p√°gina
  document.addEventListener("DOMContentLoaded", function() {
    // Uso:
    if (esLocal()) {
      console.log("Ejecutando localmente desde index.html");
      desdeDonde = 'local';
      //const csvGuardado = localStorage.getItem("csvData");
      if (csvGuardado) {
        segundos = 2;
        if (desdeDonde === 'local') {
            mostrarMensajeConTimer(`${Icons.cargando} Cargando base de datos.<br>Por favor espere: ${segundos} segundos`, "modalCargado", segundos, cargarCSV);
          //} else {
            //mostrarMensajeConTimer(`${Icons.cargando} Cargando base de datos.<br>Por favor espere: ${segundos} segundos`, "modalCargado", segundos, cargarJSON);
          }
      } else {
        segundos = 2;
        if (desdeDonde === 'local') {
          if (btnAceptar.click) {
            mostrarMensajeConTimer(`‚ÑπÔ∏è No hay ninguna base de datos cargada.!<br>Por favor espere: ${segundos} segundos y seleccione un archivo para abrir.!`, "modalCargando", segundos, cargarCSV);
          }
        } //else {
          //mostrarMensajeConTimer(`‚ÑπÔ∏è No hay ninguna base de datos cargada.!<br>Por favor espere: ${segundos} segundos mientras se carga el archivo del servidor.!`, "modalCargando", segundos, cargarJSON);
        //}
      }
    } else {
      console.log("Ejecutando desde un servidor (GitHub Pages)");
      desdeDonde = 'web';
      const datosGuardados = JSON.parse(localStorage.getItem('jsonData') || 'null');
      //const OriginalFile = localStorage.getItem(archivoOriginal);
      //const datosGuardados = JSON.parse(localStorage.getItem('csvData') || 'null');
      //const csvGuardado = JSON.parse(localStorage.getItem('csvData') || 'null');
      //cargarJSON();
      if (datosGuardados) {
        segundos = 2;
        //if (desdeDonde === 'local') {
          //mostrarMensajeConTimer(`${Icons.cargando} Cargando base de datos.<br>Por favor espere: ${segundos} segundos`, "modalCargado", segundos, cargarCSV);
        //} else {
        mostrarMensajeConTimer(`${Icons.cargando} Cargando base de datos.<br>Por favor espere: ${segundos} segundos`, "modalCargadoOnline", segundos, cargarDesdeLocalStorage);
        //}
      } else {
        segundos = 2;
        //if (!OriginalFile) {
        mostrarMensajeConTimer(`‚ÑπÔ∏è No hay ninguna base de datos cargada.!<br>Por favor espere: ${segundos} segundos mientras se carga el archivo del servidor.!`, "modalCargandoOnline", segundos, cargarJSON);
        //}
        //}
      }
    };
  });
  // Cuando el usuario hace clic en "Aceptar"
  btnAceptar.addEventListener("click", () => {
    modalCargar.style.display = "none"; // Cierra el modal
    fileInput.click(); // ‚úÖ Abre el selector de archivos
    //fileName2.addEventListener('change', e => {
      //mostrarMensajeOK(`üì¶ Archivo CSV: ${nombre} cargado y guardado localmente`, "modalCargando");
    //});
    //mostrarMensajeOK(`üì¶ Archivo CSV: ${nombre} cargado y guardado localmente`, "modalCargando");
  });

  // Si el usuario cancela
  btnCancelar.addEventListener("click", () => {
    modalCargar.style.display = "none"; // Cierra el modal sin hacer nada
  });
</script>
</body>
</html>
